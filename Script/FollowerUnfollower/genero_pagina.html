<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Instagram Follower Checker</title>

<style>
body { font-family: Arial; padding:30px; }
.box { margin-bottom:20px; padding:20px; border:1px solid #ccc; border-radius:10px; }
button { padding:10px 20px; font-size:16px; cursor:pointer; margin-top:10px; }
textarea { width:100%; height:120px; margin-top:10px; }
input[type="text"]{ padding:8px; width:100%; margin:10px 0; }
table { width:100%; border-collapse:collapse; margin-top:20px; }
th, td { padding:10px; border-bottom:1px solid #ddd; }
tr:hover { background:#f5f5f5; }
.remove-btn { cursor:pointer; color:red; font-weight:bold; }
</style>

</head>
<body>

<h2>Instagram Followers Checker (Versione Interattiva)</h2>
<p>Carica <b>followers_1.html</b> e <b>following.html</b>, poi gestisci la lista qui sotto.</p>

<div class="box">
    <label><b>1. Carica followers_1.html</b> (Chi segue TE)</label><br>
    <input type="file" id="followersFile">
</div>

<div class="box">
    <label><b>2. Carica following.html</b> (Chi TU segui)</label><br>
    <input type="file" id="followingFile">
</div>

<div class="box">
    <label><b>3. Username da escludere (uno per riga):</b></label><br>
    <textarea id="exceptions" placeholder="esempio:
cr7
@luca
pagina_inutile"></textarea>
</div>

<button onclick="processFiles()">Genera Lista</button>

<hr>

<h2>Lista NON Ricambiati</h2>

<input type="text" id="searchBox" placeholder="Cerca username..." style="display:none;">

<table id="resultsTable" style="display:none;">
    <thead>
        <tr>
            <th>Username</th>
            <th>Azione</th>
        </tr>
    </thead>
    <tbody id="resultsBody"></tbody>
</table>

<button id="downloadHtmlBtn" style="display:none;" onclick="downloadAsHtml()">Scarica come pagina HTML</button>

<script>
function extractUsernamesFromHTML(text) {
    var doc = new DOMParser().parseFromString(text, "text/html");
    var anchors = doc.querySelectorAll("a");
    var users = [];

    anchors.forEach(function(a) {
        var user = (a.textContent || "").trim().toLowerCase();
        if (user.charAt(0) === "@") user = user.substring(1);
        if (/^[a-z0-9._]+$/.test(user)) users.push(user);
    });

    return [...new Set(users)];
}

var currentList = [];

async function processFiles() {
    var followersFile = document.getElementById("followersFile").files[0];
    var followingFile = document.getElementById("followingFile").files[0];

    if (!followersFile || !followingFile) {
        alert("Carica entrambi i file.");
        return;
    }

    var followers = extractUsernamesFromHTML(await followersFile.text());
    var following = extractUsernamesFromHTML(await followingFile.text());

    var rawExceptions = document.getElementById("exceptions").value.split("\n");
    var exceptions = rawExceptions
        .map(x => x.trim().toLowerCase().replace(/^@/,""))
        .filter(v => /^[a-z0-9._]+$/.test(v));

    currentList = following.filter(u =>
        !followers.includes(u) && !exceptions.includes(u)
    );

    renderTable();
}

function renderTable() {
    var tbody = document.getElementById("resultsBody");
    tbody.innerHTML = "";

    currentList.forEach(function(user) {
        var tr = document.createElement("tr");
        tr.className = "user-row";

        // COSTRUZIONE RIGA SENZA BACKTICK
        var tdUser = document.createElement("td");
        tdUser.textContent = user;

        var tdAction = document.createElement("td");
        var span = document.createElement("span");
        span.className = "remove-btn";
        span.textContent = "Rimuovi";
        span.onclick = function() {
            removeUser(user);
        };

        tdAction.appendChild(span);
        tr.appendChild(tdUser);
        tr.appendChild(tdAction);

        tbody.appendChild(tr);
    });

    document.getElementById("resultsTable").style.display = "";
    document.getElementById("searchBox").style.display = "";
    document.getElementById("downloadHtmlBtn").style.display = "";
}

function removeUser(username) {
    currentList = currentList.filter(u => u !== username);
    renderTable();
}

document.getElementById("searchBox").addEventListener("input", function() {
    var text = this.value.toLowerCase();
    document.querySelectorAll(".user-row").forEach(function(row) {
        row.style.display = row.textContent.toLowerCase().includes(text) ? "" : "none";
    });
});

function downloadAsHtml() {
    var html = "";
    html += "<html><head><meta charset='UTF-8'><title>Non Ricambiati</title>";
    html += "<style>";
    html += "body { font-family: Arial; padding:20px; }";
    html += "table { width:100%; border-collapse:collapse; }";
    html += "th, td { padding:10px; border-bottom:1px solid #ccc; }";
    html += "</style></head><body>";
    html += "<h2>Utenti che non ricambiano il follow</h2>";
    html += "<table><tbody>";

    currentList.forEach(function(u) {
        html += "<tr><td>" + u + "</td></tr>";
    });

    html += "</tbody></table></body></html>";

    var blob = new Blob([html], { type: "text/html" });
    var url = URL.createObjectURL(blob);

    var a = document.createElement("a");
    a.href = url;
    a.download = "non_ricambiati.html";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}
</script>

</body>
</html>
